<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image HD Enhancer with Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#4f46e5',
              'brand-secondary': '#7c3aed',
              'brand-light': '#a5b4fc',
              'brand-dark': '#312e81',
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-in-out',
              'slide-up': 'slideUp 0.5s ease-out',
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
            }
          }
        }
      }
    </script>
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.28.0"
  }
}
</script>
</head>
  <body class="bg-gray-900 text-gray-100">
    <div class="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center font-sans">
      <header class="w-full text-center py-6 bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10 animate-fade-in">
        <h1 class="text-3xl md:text-5xl font-bold bg-gradient-to-r from-brand-primary via-brand-secondary to-brand-light text-transparent bg-clip-text">
          Image HD Enhancer
        </h1>
      </header>

      <div id="api-key-view" class="hidden flex-grow w-full flex items-center justify-center p-4">
        <div class="w-full max-w-lg mx-auto p-8 bg-gray-800 rounded-lg shadow-xl animate-slide-up text-center">
            <h2 class="text-2xl font-bold mb-4 text-brand-light">Masukkan Kunci API Gemini Anda</h2>
            <p class="text-gray-400 mb-6">
                Untuk menggunakan aplikasi ini, Anda memerlukan kunci API dari Google AI Studio. Kunci Anda hanya akan disimpan di browser Anda untuk sesi ini.
            </p>
            <div class="flex flex-col gap-4">
                <input 
                    id="api-key-input" 
                    type="password" 
                    class="block p-3 w-full text-sm text-center text-gray-100 bg-gray-700 rounded-lg border border-gray-600 placeholder-gray-400 focus:ring-brand-primary focus:border-brand-primary transition" 
                    placeholder="Masukkan kunci API Anda di sini"
                />
                <button 
                    id="save-api-key-btn"
                    class="bg-gradient-to-r from-brand-primary to-brand-secondary hover:from-brand-primary hover:to-brand-primary text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg"
                >
                    Simpan dan Mulai
                </button>
            </div>
            <p id="api-key-error" class="text-red-400 mt-4 text-sm hidden"></p>
            <p class="text-xs text-gray-500 mt-4">
                Tidak punya kunci? Dapatkan satu di <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="underline hover:text-brand-light">Google AI Studio</a>.
            </p>
        </div>
      </div>

      <main id="main-content" class="hidden flex-grow w-full max-w-7xl mx-auto flex-col items-center justify-center p-4">
        <div id="uploader-view" class="w-full max-w-2xl mx-auto p-4 animate-slide-up">
            <label
                id="file-label"
                for="file-upload"
                class="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-lg group border-gray-500 hover:border-brand-primary hover:bg-gray-800 cursor-pointer transition-colors"
            >
                <div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-400 group-hover:text-brand-light transition-colors">
                    <svg class="w-10 h-10 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h2l2-2h4l2 2h2a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <p class="mb-2 text-sm"><span class="font-semibold">Klik untuk mengunggah</span> atau seret dan lepas</p>
                    <p class="text-xs">PNG, JPG, WEBP (Maks. 10MB)</p>
                </div>
                <input id="file-upload" type="file" class="hidden" accept="image/png, image/jpeg, image/webp" />
            </label>
        </div>

        <div id="preview-view" class="hidden text-center p-4 flex flex-col items-center gap-6 animate-slide-up">
            <h2 class="text-xl font-semibold">Gambar Siap Ditingkatkan</h2>
            <img id="preview-image" src="" alt="Preview" class="max-h-80 w-auto rounded-lg shadow-lg" />
            
            <div class="w-full max-w-lg">
                <label for="custom-prompt" class="block mb-2 text-sm font-medium text-gray-300 text-left">Prompt Kustom (Opsional)</label>
                <textarea id="custom-prompt" rows="3" class="block p-2.5 w-full text-sm text-gray-100 bg-gray-700 rounded-lg border border-gray-600 placeholder-gray-400 focus:ring-brand-primary focus:border-brand-primary transition" placeholder="Contoh: Jadikan gambar ini terlihat seperti lukisan cat air..."></textarea>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <button 
                    id="enhance-btn"
                    class="bg-gradient-to-r from-brand-primary to-brand-secondary hover:from-brand-primary hover:to-brand-primary text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg"
                >
                    HD-kan Gambar Ini!
                </button>
                <button
                    class="reset-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg"
                >
                    Pilih Gambar Lain
                </button>
            </div>
        </div>
        
        <div id="loading-view" class="hidden flex flex-col items-center justify-center space-y-4 text-center p-8 animate-fade-in">
            <svg class="animate-spin h-12 w-12 text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg text-gray-300 font-semibold animate-pulse-fast">AI sedang bekerja meningkatkan gambar Anda...</p>
            <p class="text-sm text-gray-500">Proses ini mungkin memakan waktu sejenak...</p>
        </div>

        <div id="result-view" class="hidden w-full animate-fade-in p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                <div class="flex flex-col items-center">
                    <h2 class="text-xl font-semibold mb-3 text-gray-300">Original</h2>
                    <img id="original-image-result" src="" alt="Original" class="rounded-lg shadow-lg max-h-[60vh] w-auto object-contain" />
                </div>
                <div class="flex flex-col items-center">
                    <h2 class="text-xl font-semibold mb-3 text-brand-light">Enhanced (HD)</h2>
                    <img id="enhanced-image-result" src="" alt="Enhanced" class="rounded-lg shadow-lg max-h-[60vh] w-auto object-contain" />
                </div>
            </div>
            <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                <button
                    id="download-btn"
                    class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Unduh Gambar HD
                </button>
                <button
                    class="reset-btn w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                    Coba Gambar Lain
                </button>
            </div>
        </div>

        <div id="error-view" class="hidden text-center p-8 bg-red-900/50 border border-red-500 rounded-lg animate-fade-in">
            <h3 class="text-xl font-bold text-red-300">Oops! Terjadi Kesalahan</h3>
            <p id="error-message" class="text-red-400 mt-2"></p>
            <button class="reset-btn mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                Coba Lagi
            </button>
        </div>
      </main>

      <footer class="w-full text-center py-4 mt-auto">
          <p class="text-gray-500 text-sm">Powered by Aikacungwen</p>
          <button id="change-api-key-btn" class="hidden text-sm text-gray-400 underline hover:text-brand-light transition-colors">Ubah Kunci API</button>
      </footer>
    </div>
    <script type="module">
      import { GoogleGenAI, Modality } from "@google/genai";

      (async () => {
        // State variables
        let originalImage = null;
        let enhancedImageBase64 = null;
        let isLoading = false;
        let errorMessage = null;
        let ai;

        // DOM Elements
        const apiKeyView = document.getElementById('api-key-view');
        const mainContent = document.getElementById('main-content');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const changeApiKeyBtn = document.getElementById('change-api-key-btn');
        const apiKeyError = document.getElementById('api-key-error');

        const uploaderView = document.getElementById('uploader-view');
        const previewView = document.getElementById('preview-view');
        const loadingView = document.getElementById('loading-view');
        const resultView = document.getElementById('result-view');
        const errorView = document.getElementById('error-view');
        
        const fileInput = document.getElementById('file-upload');
        const fileLabel = document.getElementById('file-label');
        const enhanceBtn = document.getElementById('enhance-btn');
        const downloadBtn = document.getElementById('download-btn');
        const resetBtns = document.querySelectorAll('.reset-btn');

        const previewImage = document.getElementById('preview-image');
        const originalImageResult = document.getElementById('original-image-result');
        const enhancedImageResult = document.getElementById('enhanced-image-result');
        const errorMessageElement = document.getElementById('error-message');
        const customPromptInput = document.getElementById('custom-prompt');
        
        const showMainApp = () => {
            apiKeyView.classList.add('hidden');
            mainContent.classList.remove('hidden');
            mainContent.classList.add('flex');
            changeApiKeyBtn.classList.remove('hidden');
            updateUI();
        };

        const showApiKeyView = (error = '') => {
            mainContent.classList.add('hidden');
            mainContent.classList.remove('flex');
            apiKeyView.classList.remove('hidden');
            apiKeyView.classList.add('flex');
            changeApiKeyBtn.classList.add('hidden');
            if (error) {
                apiKeyError.textContent = error;
                apiKeyError.classList.remove('hidden');
            } else {
                apiKeyError.classList.add('hidden');
            }
        };
        
        const initializeAi = (apiKey) => {
            try {
                if (!apiKey) throw new Error('Kunci API tidak boleh kosong.');
                ai = new GoogleGenAI({ apiKey });
                sessionStorage.setItem('gemini-api-key', apiKey);
                showMainApp();
                return true;
            } catch (err) {
                console.error("Initialization Error:", err);
                showApiKeyView(`Gagal menginisialisasi AI. ${err.message}`);
                return false;
            }
        };

        function updateUI() {
          // Hide all main views first
          [uploaderView, previewView, loadingView, resultView, errorView].forEach(v => v.classList.add('hidden'));

          // Disable/enable file input based on loading state
          fileInput.disabled = isLoading;
          if (isLoading) {
            fileLabel.classList.add('cursor-not-allowed');
            fileLabel.classList.remove('hover:border-brand-primary', 'hover:bg-gray-800', 'cursor-pointer');
          } else {
            fileLabel.classList.remove('cursor-not-allowed');
            fileLabel.classList.add('hover:border-brand-primary', 'hover:bg-gray-800', 'cursor-pointer');
          }

          // Show the correct view
          if (isLoading) {
            loadingView.classList.remove('hidden');
          } else if (errorMessage) {
            errorMessageElement.textContent = errorMessage;
            errorView.classList.remove('hidden');
          } else if (enhancedImageBase64 && originalImage) {
            originalImageResult.src = originalImage.dataUrl;
            enhancedImageResult.src = `data:${originalImage.mimeType};base64,${enhancedImageBase64}`;
            resultView.classList.remove('hidden');
          } else if (originalImage) {
            previewImage.src = originalImage.dataUrl;
            previewView.classList.remove('hidden');
          } else {
            uploaderView.classList.remove('hidden');
          }
        }

        const enhanceImageWithGemini = async (image, customPrompt) => {
          try {
            if (!ai) throw new Error("Klien AI tidak diinisialisasi.");
            
            const defaultPrompt = 'Tingkatkan kualitas gambar ini menjadi definisi tinggi (HD). Perbaiki kejernihan, ketajaman, detail, dan warna tanpa mengubah konten aslinya. Hapus noise atau artefak kompresi jika ada. Jadikan gambar terlihat profesional dan berkualitas tinggi.';
            const promptToUse = customPrompt || defaultPrompt;

            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash-image',
              contents: {
                parts: [
                  { inlineData: { data: image.base64, mimeType: image.mimeType } },
                  { text: promptToUse },
                ],
              },
              config: {
                responseModalities: [Modality.IMAGE],
              },
            });

            for (const part of response.candidates?.[0]?.content?.parts || []) {
              if (part.inlineData) {
                return part.inlineData.data;
              }
            }
            throw new Error("Tidak ada data gambar yang ditingkatkan dalam respons API.");

          } catch (error) {
            console.error("Error enhancing image with Gemini:", error);
            if (error.message && (error.message.includes('API key not valid') || error.message.toLowerCase().includes('permission denied'))) {
                sessionStorage.removeItem('gemini-api-key');
                showApiKeyView('Kunci API tidak valid. Silakan masukkan kunci yang benar.');
                // Return a specific error to stop the loading process
                throw new Error("API Key Invalid");
            }
            if (error.message && error.message.includes('overloaded')) {
                throw new Error("Model saat ini sedang kelebihan beban. Silakan coba lagi nanti.");
            }
            throw new Error("Gagal meningkatkan kualitas gambar. Silakan periksa konsol untuk detailnya.");
          }
        };

        const fileToImageData = (file) => {
          return new Promise((resolve, reject) => {
            if (file.size > 10 * 1024 * 1024) {
                return reject(new Error("Ukuran file tidak boleh melebihi 10MB."));
            }
            const reader = new FileReader();
            reader.onload = (event) => {
              const dataUrl = event.target?.result;
              if (typeof dataUrl === 'string') {
                const base64 = dataUrl.split(',')[1];
                resolve({ dataUrl, base64, mimeType: file.type, name: file.name });
              } else {
                reject(new Error("Gagal membaca file."));
              }
            };
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
          });
        };

        const handleFileChange = async (event) => {
          const file = event.target.files?.[0];
          if (file) {
            try {
              originalImage = await fileToImageData(file);
              enhancedImageBase64 = null;
              errorMessage = null;
            } catch (error) {
              console.error("Error processing file:", error);
              errorMessage = error.message || "Gagal memproses file gambar.";
              originalImage = null;
            } finally {
              fileInput.value = '';
              updateUI();
            }
          }
        };

        const handleEnhanceClick = async () => {
          if (!originalImage) return;

          isLoading = true;
          errorMessage = null;
          updateUI();

          try {
            const customPrompt = customPromptInput.value.trim();
            enhancedImageBase64 = await enhanceImageWithGemini(originalImage, customPrompt);
          } catch (err) {
             // Special case for invalid API key, which is handled by showing the key view.
            if (err.message !== "API Key Invalid") {
                errorMessage = err.message || "Terjadi kesalahan yang tidak diketahui.";
            }
          } finally {
            isLoading = false;
            // Only update UI if we are not being redirected to API key view
            if (!apiKeyView.classList.contains('flex')) {
                updateUI();
            }
          }
        };
        
        const handleDownload = () => {
          if (!originalImage || !enhancedImageBase64) return;
          const link = document.createElement('a');
          link.href = `data:${originalImage.mimeType};base64,${enhancedImageBase64}`;
          const fileExtension = originalImage.name.split('.').pop() || 'png';
          link.download = `${originalImage.name.replace(/\.[^/.]+$/, "")}_enhanced.${fileExtension}`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        const handleReset = () => {
          originalImage = null;
          enhancedImageBase64 = null;
          isLoading = false;
          errorMessage = null;
          fileInput.value = '';
          customPromptInput.value = '';
          updateUI();
        };

        const handleApiKeySubmit = () => {
            const apiKey = apiKeyInput.value.trim();
            initializeAi(apiKey);
        };

        // Event Listeners
        fileInput.addEventListener('change', handleFileChange);
        enhanceBtn.addEventListener('click', handleEnhanceClick);
        downloadBtn.addEventListener('click', handleDownload);
        resetBtns.forEach(btn => btn.addEventListener('click', handleReset));
        saveApiKeyBtn.addEventListener('click', handleApiKeySubmit);
        apiKeyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleApiKeySubmit();
            }
        });
        changeApiKeyBtn.addEventListener('click', () => {
            sessionStorage.removeItem('gemini-api-key');
            ai = null;
            apiKeyInput.value = '';
            showApiKeyView();
        });
        
        fileLabel.addEventListener('dragover', (event) => {
          event.preventDefault();
          if (!isLoading) fileLabel.classList.add('border-brand-primary', 'bg-gray-800');
        });
        fileLabel.addEventListener('dragleave', () => fileLabel.classList.remove('border-brand-primary', 'bg-gray-800'));
        fileLabel.addEventListener('drop', (event) => {
          event.preventDefault();
          if (isLoading) return;
          fileLabel.classList.remove('border-brand-primary', 'bg-gray-800');
          if (event.dataTransfer.files && event.dataTransfer.files[0]) {
              handleFileChange({ target: { files: event.dataTransfer.files } });
          }
        });

        // App Initialization
        const storedApiKey = sessionStorage.getItem('gemini-api-key');
        if (storedApiKey) {
            initializeAi(storedApiKey);
        } else {
            showApiKeyView();
        }

      })();
    </script>
  </body>
</html>